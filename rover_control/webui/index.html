<!DOCTYPE html>
<html>
<head>
  <title>Rover Control Center</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  
  <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.min.js"></script>

  <style>
    body { background-color: #222; color: #eee; }
    .card { background-color: #333; margin-bottom: 20px; }
    #camera-stream { width: 100%; border: 2px solid #555; }
    #joystick-zone { height: 200px; position: relative; border: 1px dashed #555; }
    .slider-val { font-weight: bold; color: #007bff; }
    .status-ok { color: #28a745; }
    .status-err { color: #dc3545; }
  </style>
</head>
<body>

<div class="container mt-3">
  <h2 class="text-center">Six-Wheel Rover Command</h2>
  
  <div class="row">
    <div class="col-md-6">
      
      <div class="card p-2">
        <div>ROS Status: <span id="status" class="status-err">Disconnected</span></div>
        <div>Battery: <span id="battery">--</span> V</div>
      </div>

      <div class="card">
        <div class="card-header">Camera Feed</div>
        <div class="card-body p-0">
          <img id="camera-stream" src="" alt="Waiting for Video..." />
        </div>
      </div>

    </div>

    <div class="col-md-6">
      
      <div class="card">
        <div class="card-header">Locomotion</div>
        <div class="card-body">
          <div id="joystick-zone"></div>
          <div class="text-center text-muted mt-2">Touch/Drag to Drive</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          Arm Control 
          <button class="btn btn-sm btn-warning float-right" onclick="toggleArm()">Toggle Power</button>
        </div>
        <div class="card-body">
          <div id="sliders-container"></div>
          <button class="btn btn-primary btn-block mt-3" onclick="sendArmCmd()">Move Arm</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // --- CONFIGURATION ---
  // CHANGE THIS TO YOUR PC IP ADDRESS
  const ROS_IP = "192.168.1.100"; 
  
  // Setup Camera Source
  document.getElementById("camera-stream").src = 
    `http://${ROS_IP}:8080/stream?topic=/camera/rgb/image_color&type=mjpeg&quality=50`;

  // --- ROS CONNECTION ---
  const ros = new ROSLIB.Ros({
    url : `ws://${ROS_IP}:9090`
  });

  ros.on('connection', () => {
    document.getElementById("status").innerHTML = "Connected";
    document.getElementById("status").className = "status-ok";
  });

  ros.on('error', (error) => {
    document.getElementById("status").innerHTML = "Error";
    document.getElementById("status").className = "status-err";
  });

  ros.on('close', () => {
    document.getElementById("status").innerHTML = "Closed";
    document.getElementById("status").className = "status-err";
  });

  // --- TOPICS ---
  // cmd_vel (Joystick)
  const cmdVel = new ROSLIB.Topic({
    ros : ros,
    name : '/cmd_vel',
    messageType : 'geometry_msgs/Twist'
  });

  // Arm Command
  const armCmd = new ROSLIB.Topic({
    ros : ros,
    name : '/rover/arm_cmd',
    messageType : 'std_msgs/Int16MultiArray'
  });

  // Arm Enable
  const armEnable = new ROSLIB.Topic({
    ros : ros,
    name : '/rover/arm_enable',
    messageType : 'std_msgs/Bool'
  });

  // Battery Sub
  const batSub = new ROSLIB.Topic({
    ros : ros,
    name : '/rover/battery',
    messageType : 'sensor_msgs/BatteryState'
  });

  batSub.subscribe((msg) => {
    document.getElementById("battery").innerText = msg.voltage.toFixed(2);
  });

  // --- JOYSTICK LOGIC ---
  const manager = nipplejs.create({
    zone: document.getElementById('joystick-zone'),
    mode: 'static',
    position: {left: '50%', top: '50%'},
    color: 'white'
  });

  let moveInterval;

  manager.on('move', (evt, data) => {
    // Convert Joystick Data to Twist
    // data.vector.y is forward (0 to 1)
    // data.vector.x is turn (-1 to 1)
    
    // Max Speed Scaling
    const max_lin = 0.5; // m/s
    const max_ang = 1.0; // rad/s

    // Joystick gives approx 50px distance as max
    const dist = Math.min(data.distance, 50) / 50.0;
    const angle = data.angle.radian;

    const x = Math.sin(angle) * dist * max_lin;
    const z = -Math.cos(angle) * dist * max_ang;

    const twist = new ROSLIB.Message({
      linear : { x : x, y : 0, z : 0 },
      angular : { x : 0, y : 0, z : z }
    });
    
    cmdVel.publish(twist);
  });

  manager.on('end', () => {
    // Stop robot on release
    cmdVel.publish(new ROSLIB.Message({
      linear: {x:0, y:0, z:0}, angular: {x:0, y:0, z:0}
    }));
  });

  // --- ARM LOGIC ---
  const axesNames = ["Base Pan", "Shoulder", "Elbow", "Wrist Pitch", "Wrist Roll"];
  const sliderRanges = [4000, 4000, 4000, 2000, 2000]; // Max steps +/-

  const container = document.getElementById('sliders-container');
  
  axesNames.forEach((name, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <label>${name}: <span id="val-${i}" class="slider-val">0</span></label>
      <input type="range" class="custom-range" id="slider-${i}" 
             min="-${sliderRanges[i]}" max="${sliderRanges[i]}" value="0"
             oninput="document.getElementById('val-${i}').innerText = this.value">
    `;
    container.appendChild(div);
  });

  function sendArmCmd() {
    let steps = [];
    for(let i=0; i<5; i++) {
      steps.push(parseInt(document.getElementById(`slider-${i}`).value));
    }
    
    const msg = new ROSLIB.Message({
      layout: { dim: [], data_offset: 0 },
      data: steps
    });
    armCmd.publish(msg);
  }

  let powerState = true;
  function toggleArm() {
    powerState = !powerState;
    armEnable.publish(new ROSLIB.Message({ data: powerState }));
    alert("Arm Power: " + (powerState ? "ON" : "OFF"));
  }

</script>
</body>
</html>
